

# 1. xl 常用命令
- create
- destroy
- shutdown，虚拟机需要可以接收shutdown命令，busybox是不可以的
- reboot，重启
- pci
  - pci-list
  - pci-attach 热插拔
  - pci-detach
- 暂停
  - pause，暂停主机，定格在内存中，和vmware的挂起不一样。宿主机关机，虚拟机的未保存信息全部会丢失
  - unpause，解除暂停
- 挂起
  - save，挂起，将dom0内存中的数据转存至磁盘文件中。磁盘文件可以自行制定，还需要指定创建时的配置文件，这是因为这个busybox虚拟机的内核不在其本身的磁盘镜像中，而是在dom0中
    - ```xl save busybox-001 /tmp/busybox.img /etc/xen/busybox_conf```
  - restore，从指定的磁盘中恢复  
    - ```xl restore /etc/xen/busybox_conf /tmp/busybox.img```
- migrate
- cdrom
  - cd-insert
  - cd-eject 弹出光驱
- mem-max
- men-set
- vcpu
  - vcpu-list
    - ```xl vcpu-list busybox-001```
  - vcpu-pin
   - ```xl vcpu-pin busybox-001 0 3```，虚拟机vcpu的第0个核心，固定在物理cpu的第三个核心
  - vcpu-set，指定使用几个vcpu核心，需要少于创建虚拟机时给定的vcpu个数
- info，查看xen-hypervisor的信息
- domid
- domname
- dmesg，显示虚拟机启动时，引导时的信息
- top，显示各虚拟机资源占用情况
- network
  - network-list，查看现有虚拟机的网络接口
  - network-attach，网卡热插，添加新网卡
    - ```x network-attach busybox-001 bridge=xenbr1```，宿主机上会显示vif1.0和vif1.1两个网卡
  - network-detach
    - ```x network-detach busybox-001 1```，后面的1时网卡设备的idx，需要使用network-list命令来查看
- 磁盘
  - 创建新磁盘镜像，qcow2可以创建快照，而raw不可以
    - ```qemu-img create -f qcow2 -o ? /images/xen/busybox1.2.img```，？问号可以查看可使用参数
    - ```qemu-img create -f qcow2 -o size=5G,prealloation=metadata /images/xen/busybox1.2.qcow2```，只预创建出metadata
  - block-list，现有磁盘设备
  - block-attach
    - ```xl block-attach busybox-001 '/images/xen/busybox1.2.img,qcow2,xvdb,w'```
    - 进入虚拟机```fdish -l```查看全部磁盘，```fdisk  /dev/xvdb```可以进行磁盘分区
  - block-datach
    - ```xl block-attach busybox-001 51728```，磁盘idx需用通过block-list来查看
- uptime，查看运行时长

# 2. 使用domU自有kernel启动domU
## 2.1 创建镜像文件
- qemu-img create -f qcow2 -o size=5G,preallocation=metadata /images/xen/busybox3.img
## 2.2 磁盘分区，格式化
- 分区
  - boot，kernel，initrd
  - 根文件系统
- 关联到本地回环设备losetup，/dev目录下的loop1-loop7都可以当作本地回环设备
  - 其实 mount -o loop 命令就会自动将loop0-7关联至本地回环设备，比如/images/xen/busybox.img
  - 也可以通过losetup来手动实现
  - losetup -a 显示所有医用loop设备
  - losetup -f 显示第一个可用loop设备
  
#### 1. 关联loop设备和磁盘镜像文件
- losetup loop1 /images/xen/busybox3.img
#### 2. 对loop1分区
- fdisk /dev/loop1
  - partition 1 = 50M
  - partition 2 = 1G
  - w
- kpartx -av/dev/loop1，显示loop1的分区loop1p1和loop1p2
  - ls /dev/mapper下面可以看到分区路径loop1p1和loop1p2，可以直接cd进行访问
#### 3. 格式化分区
- mke2fs -t ext2 /dev/mapper/loop1p1
- mke2fs -t ext2 /dev/mapper/loop1p2
此时可以按照分区进行分别挂载，并拷贝相应文件至相应分区
#### 4. 挂载分区
- 在/mnt下为每个分区创建一个挂载目录
  - mkdir /mnt{boot,sysroot}
- mount /dev/mapper/loop1p1 /mnt/boot/
- mount /dev/mapper/loop1p2 /mnt/sysroot/
## 2.3 拷贝内核文件至分区目录
#### 1. boot目录
- cp /boot/vmlinuz-2.6.32 /mnt/boot/vmlinux
- cp /boot/initramfs-2.6.32.img /mnt/boot/initramfs.img
- 安装grub
  - grub-install --root-directory=/mnt /dev/loop1，此处指定磁盘，而不是分区，命令会自动在/mnt下找到boot目录，把grub分拣安装进去
  - 会提示no corresponding BIOS drive，但无所谓，查看ls /mnt/boot/，会出现grub目录，而且该grub目录下会生成一些文件
  - 在/mnt/boot/grub/目录下创建grub.conf文件
    ```
    default=0
    timeout=5
    title BusyBox(kernel-2.6.32)
      root (hd0,0)
      kernel /vmlinuz root=/dev/xvda1 ro selinux=0 init=/bin/sh
      initrd /initramfs.img
    ```
#### 2. sysroot目录
- ```cp -a /root/busybox-1.23.0/_install/* /mnt/sysroot/```
- cd /mnt/sysroot
  - mkdir -pv lib/modules etc dev var proc sys tmp
  - cp /lib/modules/2.6.32/kernel/drivers/net/xen-netfront.ko lib/modules 
- sync，同步一下

#### 3. 拆除loop设备
- umount /mnt/boot，umount关闭访问映射路径
- umount /mnt/sysroot
- kpartx -d /dev/loop1
- losetup -d /dev/loop1，上一步执行之后，losetup -a应该就已经查看不到loop设备了

## 2.4 准备虚拟机配置文件
- cp /etc/xen/busybox_conf busybox_conf3
- vim busybox_conf3
  ```
  name=busybox-003
  #kernel
  #ramdisk
  #extra
  vif = ['bridge=xenbr0']
  disk = ['/images/xen/busybox3.img,qcow2,xvda,rw']
  #root
  bootloader = '/usr/bin/pygrub'
  ```
  - pygrub会当作mdr的第一个来引导，它会自动读取设备上的第二个，即/images/xen/busybox3.img

## 2.5 创建虚拟机
- xl -v create /etc/xen/busybox_conf3，失败
  - 改配置文件，最后加一行 ```builder = ‘hvm’```，也还是失败
  - qcow2格式 不支持！！！！！
## 2.6 重新再创建一个raw的磁盘镜像  
































